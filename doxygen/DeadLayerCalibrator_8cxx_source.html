<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>cnipol: /direct/eic+u/dsmirnov/cnipol/src/DeadLayerCalibrator.cxx Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_e1dca166ec6abb4ef5a7ad269392aef6.html">src</a>
  </div>
</div>
<div class="contents">
<h1>DeadLayerCalibrator.cxx</h1><a href="DeadLayerCalibrator_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;<a class="code" href="DeadLayerCalibrator_8h.html">DeadLayerCalibrator.h</a>&quot;</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <a class="code" href="AlphaCalibrator_8cxx.html#a2e4eff40c749ecbebe6e9a0ec9ed6c8d">ClassImp</a>(<a class="code" href="classDeadLayerCalibrator.html">DeadLayerCalibrator</a>)
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 using namespace std;
<a name="l00007"></a>00007 using namespace ROOT::Fit;
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 
<a name="l00011"></a><a class="code" href="classDeadLayerCalibrator.html#a94d429d344dc5a91c448c738fce434f2">00011</a> <span class="keywordtype">void</span> <a class="code" href="classDeadLayerCalibrator.html">DeadLayerCalibrator</a>::Calibrate(<a class="code" href="classDrawObjContainer.html">DrawObjContainer</a> *c)
<a name="l00012"></a>00012 {
<a name="l00013"></a>00013    TH2F *htemp     = (TH2F*) c-&gt;d[<span class="stringliteral">&quot;preproc&quot;</span>]-&gt;o[<span class="stringliteral">&quot;hTimeVsEnergyA&quot;</span>];
<a name="l00014"></a>00014    TH1D *hMeanTime = (TH1D*) c-&gt;d[<span class="stringliteral">&quot;preproc&quot;</span>]-&gt;o[<span class="stringliteral">&quot;hFitMeanTimeVsEnergyA&quot;</span>];
<a name="l00015"></a>00015 
<a name="l00016"></a>00016    <span class="keywordflow">if</span> (!htemp || !hMeanTime) {
<a name="l00017"></a>00017       Error(<span class="stringliteral">&quot;Calibrate&quot;</span>, <span class="stringliteral">&quot;Histogram preproc/hTimeVsEnergyA does not exist&quot;</span>);
<a name="l00018"></a>00018       Error(<span class="stringliteral">&quot;Calibrate&quot;</span>, <span class="stringliteral">&quot;Histogram preproc/hFitMeanTimeVsEnergyA does not exist&quot;</span>);
<a name="l00019"></a>00019       <span class="keywordflow">return</span>;
<a name="l00020"></a>00020    }
<a name="l00021"></a>00021 
<a name="l00022"></a>00022    <span class="keywordflow">if</span> (htemp-&gt;Integral() &lt; 1000) {
<a name="l00023"></a>00023       Error(<span class="stringliteral">&quot;Calibrate&quot;</span>, <span class="stringliteral">&quot;Too few entries in histogram preproc/hTimeVsEnergyA. Skipped&quot;</span>);
<a name="l00024"></a>00024       <span class="keywordflow">return</span>;
<a name="l00025"></a>00025    }
<a name="l00026"></a>00026 
<a name="l00027"></a>00027    TFitResultPtr fitres = CalibrateOld(htemp, hMeanTime, 0, <span class="keyword">true</span>);
<a name="l00028"></a>00028 
<a name="l00029"></a>00029    <span class="comment">// Put results into &quot;channel 0&quot;</span>
<a name="l00030"></a>00030    UInt_t chId = 0;
<a name="l00031"></a>00031    <a class="code" href="classChannelCalib.html" title="A data container to hold a complete set of calibration parameters for each detector...">ChannelCalib</a> *chCalib;
<a name="l00032"></a>00032    ChannelCalibMap::iterator iChCalib = fChannelCalibs.find(chId);
<a name="l00033"></a>00033 
<a name="l00034"></a>00034    <span class="keywordflow">if</span> (iChCalib != fChannelCalibs.end())  {
<a name="l00035"></a>00035       chCalib = &amp;iChCalib-&gt;second;
<a name="l00036"></a>00036    } <span class="keywordflow">else</span> {
<a name="l00037"></a>00037       <a class="code" href="classChannelCalib.html" title="A data container to hold a complete set of calibration parameters for each detector...">ChannelCalib</a> newChCalib;
<a name="l00038"></a>00038       fChannelCalibs[chId] = newChCalib;
<a name="l00039"></a>00039       chCalib = &amp;fChannelCalibs[chId];
<a name="l00040"></a>00040    }
<a name="l00041"></a>00041 
<a name="l00042"></a>00042    <span class="keywordflow">if</span> (fitres.Get()) {
<a name="l00043"></a>00043       chCalib-&gt;<a class="code" href="classChannelCalib.html#a3f2f79f9fda41cfff46bad6628540f3c">fBananaChi2Ndf</a> = fitres-&gt;Ndf() &gt; 0 ? fitres-&gt;Chi2()/fitres-&gt;Ndf() : -1;
<a name="l00044"></a>00044       chCalib-&gt;<a class="code" href="classChannelCalib.html#a5108e031c293c33b684b919103b5297c" title="Average time offset for all triggers.">fT0Coef</a>        = fitres-&gt;Value(0);
<a name="l00045"></a>00045       chCalib-&gt;<a class="code" href="classChannelCalib.html#ac28535c05c6faeee513b7f6969f9f791" title="Error on the average time offset for all triggers.">fT0CoefErr</a>     = fitres-&gt;FitResult::Error(0);
<a name="l00046"></a>00046       chCalib-&gt;<a class="code" href="classChannelCalib.html#ab2751e3e72ccfd99f2ef4f1d03eee6a7" title="Missing energy not registered by the detector channel. Estimated from the banana...">fAvrgEMiss</a>     = fitres-&gt;Value(1);
<a name="l00047"></a>00047       chCalib-&gt;<a class="code" href="classChannelCalib.html#af9b276d537a35f0eba369d217e196ff9" title="Error on fAvrgEMiss estimated from the banana fit.">fAvrgEMissErr</a>  = fitres-&gt;FitResult::Error(1);
<a name="l00048"></a>00048    } <span class="keywordflow">else</span> {
<a name="l00049"></a>00049       Error(<span class="stringliteral">&quot;Calibrate&quot;</span>, <span class="stringliteral">&quot;Empty TFitResultPtr&quot;</span>);
<a name="l00050"></a>00050    }
<a name="l00051"></a>00051 }
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 
<a name="l00055"></a><a class="code" href="classDeadLayerCalibrator.html#a0249fd9faf936bb1c244925220ba3867">00055</a> TFitResultPtr <a class="code" href="classDeadLayerCalibrator.html#a0249fd9faf936bb1c244925220ba3867">DeadLayerCalibrator::CalibrateOld</a>(TH1 *h, TH1D *hMeanTime, UShort_t chId, Bool_t wideLimits)
<a name="l00056"></a>00056 {
<a name="l00057"></a>00057    Double_t xmin = h-&gt;GetXaxis()-&gt;GetXmin();
<a name="l00058"></a>00058    <span class="comment">// Energy dependent fit function fails when E = 0</span>
<a name="l00059"></a>00059    xmin = xmin == 0 ? 1 : xmin;
<a name="l00060"></a>00060    Double_t xmax = h-&gt;GetXaxis()-&gt;GetXmax();
<a name="l00061"></a>00061 
<a name="l00062"></a>00062    Double_t ymin = h-&gt;GetYaxis()-&gt;GetXmin();
<a name="l00063"></a>00063    Double_t ymax = h-&gt;GetYaxis()-&gt;GetXmax();
<a name="l00064"></a>00064 
<a name="l00065"></a>00065    TObjArray fitResHists;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067    TF1* gausFitFunc = <span class="keyword">new</span> TF1(<span class="stringliteral">&quot;gausFitFunc&quot;</span>, <span class="stringliteral">&quot;gaus&quot;</span>, ymin, ymax);
<a name="l00068"></a>00068 
<a name="l00069"></a>00069    ((TH2F*) h)-&gt;FitSlicesY(gausFitFunc, 0, -1, 0, <span class="stringliteral">&quot;QNR G5&quot;</span>, &amp;fitResHists);
<a name="l00070"></a>00070 
<a name="l00071"></a>00071    hMeanTime-&gt;Set(((TH1D*)fitResHists[1])-&gt;GetNbinsX()+2, ((TH1D*) fitResHists[1])-&gt;GetArray());
<a name="l00072"></a>00072    hMeanTime-&gt;SetError(((TH1D*) fitResHists[1])-&gt;GetSumw2()-&gt;GetArray());
<a name="l00073"></a>00073 
<a name="l00074"></a>00074    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i&lt;=hMeanTime-&gt;GetNbinsX(); i++) {
<a name="l00075"></a>00075 
<a name="l00076"></a>00076       <span class="keywordflow">if</span> (hMeanTime-&gt;GetBinContent(i) &gt; 0 &amp;&amp; hMeanTime-&gt;GetBinError(i) &lt; 0.20)
<a name="l00077"></a>00077          hMeanTime-&gt;SetBinError(i, 0.20);   <span class="comment">// works for blue2</span>
<a name="l00078"></a>00078    }
<a name="l00079"></a>00079 
<a name="l00080"></a>00080    TF1 *bananaFitFunc = <span class="keyword">new</span> TF1(<span class="stringliteral">&quot;bananaFitFunc&quot;</span>, <a class="code" href="classDeadLayerCalibrator.html#a1118db7b12b3ffddc59967cf68992677">DeadLayerCalibrator::BananaFitFunc</a>, xmin, xmax, 2);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082    bananaFitFunc-&gt;SetNpx(1000);
<a name="l00083"></a>00083 
<a name="l00084"></a>00084    <span class="comment">// Set expected values and limits</span>
<a name="l00085"></a>00085    <span class="keywordtype">float</span> meanT0      = 20;
<a name="l00086"></a>00086    <span class="keywordtype">float</span> meanEm      = 100;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088    <span class="comment">// All channels are combined in the 0-th calib channel</span>
<a name="l00089"></a>00089    <span class="comment">// Use these values as expected in the fit</span>
<a name="l00090"></a>00090    ChannelCalibMap::iterator iChCalib = <a class="code" href="classCalibrator.html#ae4c41602408843732703b555cabb25a7">fChannelCalibs</a>.find(0);
<a name="l00091"></a>00091 
<a name="l00092"></a>00092    <span class="keywordflow">if</span> (iChCalib != <a class="code" href="classCalibrator.html#ae4c41602408843732703b555cabb25a7">fChannelCalibs</a>.end())  {
<a name="l00093"></a>00093       meanT0     = <a class="code" href="classCalibrator.html#ae4c41602408843732703b555cabb25a7">fChannelCalibs</a>[0].fT0Coef;
<a name="l00094"></a>00094       meanEm     = <a class="code" href="classCalibrator.html#ae4c41602408843732703b555cabb25a7">fChannelCalibs</a>[0].fAvrgEMiss;
<a name="l00095"></a>00095    }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097    <span class="keywordtype">float</span> meanT0_low   = meanT0 &lt; 0 ? 1.5*meanT0 : 0.5*meanT0;
<a name="l00098"></a>00098    <span class="keywordtype">float</span> meanT0_high  = meanT0 &lt; 0 ? 0.5*meanT0 : 1.5*meanT0;
<a name="l00099"></a>00099    <span class="keywordtype">float</span> meanEm_low   = 0.5*meanEm;
<a name="l00100"></a>00100    <span class="keywordtype">float</span> meanEm_high  = 1.5*meanEm;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102    <span class="keywordflow">if</span> (wideLimits) {
<a name="l00103"></a>00103       meanT0_low   = -30;
<a name="l00104"></a>00104       meanT0_high  = 30;
<a name="l00105"></a>00105       meanEm_low   = 0;
<a name="l00106"></a>00106       meanEm_high  = 200;
<a name="l00107"></a>00107    }
<a name="l00108"></a>00108 
<a name="l00109"></a>00109    bananaFitFunc-&gt;SetParameters(meanT0, meanEm);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111    bananaFitFunc-&gt;SetParLimits(0, meanT0_low, meanT0_high);
<a name="l00112"></a>00112    bananaFitFunc-&gt;SetParLimits(1, meanEm_low, meanEm_high);
<a name="l00113"></a>00113 
<a name="l00114"></a>00114    hMeanTime-&gt;Print();
<a name="l00115"></a>00115    TFitResultPtr fitres = hMeanTime-&gt;Fit(bananaFitFunc, <span class="stringliteral">&quot;I M E S R&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00116"></a>00116 
<a name="l00117"></a>00117    <span class="keyword">delete</span> gausFitFunc;
<a name="l00118"></a>00118    <span class="keyword">delete</span> bananaFitFunc;
<a name="l00119"></a>00119 
<a name="l00120"></a>00120    <span class="keywordflow">return</span> fitres;
<a name="l00121"></a>00121 }
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="classDeadLayerCalibrator.html#a1118db7b12b3ffddc59967cf68992677">00124</a> Double_t <a class="code" href="classDeadLayerCalibrator.html#a1118db7b12b3ffddc59967cf68992677">DeadLayerCalibrator::BananaFitFunc</a>(Double_t *<a class="code" href="KinFunc_8cxx.html#ad0da36b2558901e21e7a30f6c227a45e">x</a>, Double_t *par)
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126    Double_t e_meas      = x[0];
<a name="l00127"></a>00127    Double_t t0          = par[0];
<a name="l00128"></a>00128    Double_t avrgELoss = par[1];
<a name="l00129"></a>00129    Double_t e_kin = e_meas + avrgELoss;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131    Double_t t_meas;
<a name="l00132"></a>00132 
<a name="l00133"></a>00133    <span class="keywordflow">if</span> (e_kin != 0.0)
<a name="l00134"></a>00134       t_meas = TMath::Sqrt(<a class="code" href="AsymHeader_8h.html#abea4578519a3e22ada04c12244c564c8">MASS_12C</a>/2./e_kin) / <a class="code" href="AsymHeader_8h.html#a8603da2b4b6ef38d985dc9c729b91f86">C_CMNS</a> * <a class="code" href="AsymHeader_8h.html#a267051c04bff7f77fa83116ac1327853">CARBON_PATH_DISTANCE</a> - t0;
<a name="l00135"></a>00135    <span class="keywordflow">else</span>
<a name="l00136"></a>00136       t_meas = DBL_MAX;
<a name="l00137"></a>00137 
<a name="l00138"></a>00138    <span class="keywordflow">return</span> t_meas;
<a name="l00139"></a>00139 }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 
<a name="l00143"></a><a class="code" href="classDeadLayerCalibrator.html#aeb63cd4b4188bead1b8f9134dd35dac1">00143</a> Double_t <a class="code" href="classDeadLayerCalibrator.html#aeb63cd4b4188bead1b8f9134dd35dac1">DeadLayerCalibrator::BananaFitFunc2</a>(Double_t *<a class="code" href="KinFunc_8cxx.html#ad0da36b2558901e21e7a30f6c227a45e">x</a>, Double_t *par)
<a name="l00144"></a>00144 {
<a name="l00145"></a>00145    Double_t t_meas = x[0];
<a name="l00146"></a>00146    Double_t e_meas = x[1];
<a name="l00147"></a>00147    Double_t t0     = par[0];
<a name="l00148"></a>00148 
<a name="l00149"></a>00149    Double_t e_miss = fabs(e_meas -
<a name="l00150"></a>00150       <a class="code" href="AsymHeader_8h.html#abea4578519a3e22ada04c12244c564c8">MASS_12C</a>*<a class="code" href="AsymHeader_8h.html#a267051c04bff7f77fa83116ac1327853">CARBON_PATH_DISTANCE</a>*<a class="code" href="AsymHeader_8h.html#a267051c04bff7f77fa83116ac1327853">CARBON_PATH_DISTANCE</a>/ 2. / (t_meas + t0)/(t_meas + t0));
<a name="l00151"></a>00151 
<a name="l00152"></a>00152    <span class="keywordflow">return</span> e_miss;
<a name="l00153"></a>00153 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 3 Dec 2014 for cnipol by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
