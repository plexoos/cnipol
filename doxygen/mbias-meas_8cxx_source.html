<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>cnipol: /direct/eic+u/dsmirnov/cnipol/src/mbias-meas.cxx Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_e1dca166ec6abb4ef5a7ad269392aef6.html">src</a>
  </div>
</div>
<div class="contents">
<h1>mbias-meas.cxx</h1><a href="mbias-meas_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;map&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;numeric&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;mysql++.h&gt;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="malpha_8h.html">malpha.h</a>&quot;</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;TEnv.h&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;TROOT.h&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;TLegend.h&quot;</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="MAlphaAnaInfo_8h.html">MAlphaAnaInfo.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="AsymHeader_8h.html">AsymHeader.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="MeasInfo_8h.html">MeasInfo.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="SshLogReader_8h.html">SshLogReader.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="CachingLogReader_8h.html">CachingLogReader.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="BiasCurrentUtil_8h.html">BiasCurrentUtil.h</a>&quot;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="DrawObjContainer_8h.html">DrawObjContainer.h</a>&quot;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;utils/utils.h&quot;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="keyword">using namespace </span>std;
<a name="l00029"></a>00029 
<a name="l00030"></a><a class="code" href="structResult.html">00030</a> <span class="keyword">struct </span><a class="code" href="structResult.html">Result</a>
<a name="l00031"></a>00031 {
<a name="l00032"></a><a class="code" href="structResult.html#aa350123fa5999911729ce66125eb70b9">00032</a>    map&lt;string, vector&lt;double&gt; &gt;   <a class="code" href="structResult.html#aa350123fa5999911729ce66125eb70b9">second</a>;
<a name="l00033"></a><a class="code" href="structResult.html#ad67ff3331aa0731a73843baffaf99984">00033</a>    <span class="keywordtype">string</span>   <a class="code" href="structResult.html#ad67ff3331aa0731a73843baffaf99984">YTitle</a>;
<a name="l00034"></a>00034 
<a name="l00035"></a>00035    <span class="comment">// used for histogram limits</span>
<a name="l00036"></a><a class="code" href="structResult.html#a637ca655a5c07576ff5373e792adabf6">00036</a>    <span class="keywordtype">double</span>       <a class="code" href="structResult.html#a637ca655a5c07576ff5373e792adabf6">min_value</a>, <a class="code" href="structResult.html#a7c22561326cbb70f262b5403e01c6921">max_value</a>;
<a name="l00037"></a><a class="code" href="structResult.html#aae147943622a916d03ce3ca976722b4c">00037</a>    <span class="keywordtype">double</span>       <a class="code" href="structResult.html#ac6e26e4d55c3b38c4fb58efbf7123edc">mean</a>, <a class="code" href="structResult.html#aae147943622a916d03ce3ca976722b4c">sigma</a>;
<a name="l00038"></a>00038 };
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="mbias-meas_8cxx.html#a66a1ea97d930538136475ce6d690c814">00041</a> <span class="keywordtype">void</span> <a class="code" href="malpha_8cxx.html#a268f9dbb10016e6868784b38d350c51e">FillDeviceMaxMin</a>(map&lt;Short_t, Result&gt; &amp;results)
<a name="l00042"></a>00042 {
<a name="l00043"></a>00043    <span class="keywordtype">double</span> min_value = FLT_MAX;
<a name="l00044"></a>00044    <span class="keywordtype">double</span> max_value = -FLT_MAX;
<a name="l00045"></a>00045 
<a name="l00046"></a>00046    <span class="keywordtype">double</span> mean_sum = 0;
<a name="l00047"></a>00047    <span class="keywordtype">int</span> count = 0;
<a name="l00048"></a>00048 
<a name="l00049"></a>00049    <span class="keywordflow">for</span> (map&lt;Short_t, Result&gt;::const_iterator i = results.begin(); i != results.end(); i++)
<a name="l00050"></a>00050    {
<a name="l00051"></a>00051       <span class="keyword">const</span> <a class="code" href="structResult.html">Result</a> &amp;result = i-&gt;second;
<a name="l00052"></a>00052 
<a name="l00053"></a>00053       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> det = 0; det &lt; <a class="code" href="AsymHeader_8h.html#a4141e3782935f973100a9c0a9efd03b7">N_DETECTORS</a>; det++)
<a name="l00054"></a>00054       {
<a name="l00055"></a>00055          <span class="comment">// find min and max values</span>
<a name="l00056"></a>00056          <span class="keywordflow">for</span> (map&lt;<span class="keywordtype">string</span>, vector&lt;double&gt; &gt;::const_iterator it = result.<a class="code" href="structResult.html#aa350123fa5999911729ce66125eb70b9">second</a>.begin(); it != result.<a class="code" href="structResult.html#aa350123fa5999911729ce66125eb70b9">second</a>.end(); it++)
<a name="l00057"></a>00057          {
<a name="l00058"></a>00058             <span class="keywordtype">double</span> value = it-&gt;second[det];
<a name="l00059"></a>00059             <span class="keywordflow">if</span> (min_value &gt; value)
<a name="l00060"></a>00060             {
<a name="l00061"></a>00061                min_value = value;
<a name="l00062"></a>00062             }
<a name="l00063"></a>00063             <span class="keywordflow">if</span> (max_value &lt; value)
<a name="l00064"></a>00064             {
<a name="l00065"></a>00065                max_value = value;
<a name="l00066"></a>00066             }
<a name="l00067"></a>00067          }
<a name="l00068"></a>00068 
<a name="l00069"></a>00069          <span class="comment">// also we use information about mean values and their width</span>
<a name="l00070"></a>00070          <span class="comment">// to calculate limits for plots that are not interested in outliers (such as PlotMean())</span>
<a name="l00071"></a>00071          <span class="keywordflow">for</span> (map&lt;<span class="keywordtype">string</span>, vector&lt;double&gt; &gt;::const_iterator it = result.<a class="code" href="structResult.html#aa350123fa5999911729ce66125eb70b9">second</a>.begin(); it != result.<a class="code" href="structResult.html#aa350123fa5999911729ce66125eb70b9">second</a>.end(); it++)
<a name="l00072"></a>00072          {
<a name="l00073"></a>00073             <span class="keywordtype">double</span> value = it-&gt;second[det];
<a name="l00074"></a>00074             <span class="keywordflow">if</span> (!isnan(value))
<a name="l00075"></a>00075             {
<a name="l00076"></a>00076                mean_sum += value;
<a name="l00077"></a>00077                count++;
<a name="l00078"></a>00078             }
<a name="l00079"></a>00079          }
<a name="l00080"></a>00080       }
<a name="l00081"></a>00081    }
<a name="l00082"></a>00082    <span class="keywordtype">double</span> mean = mean_sum / count;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084    <span class="keywordtype">int</span> count_crosscheck = 0;
<a name="l00085"></a>00085    <span class="keywordtype">double</span> sigma_sum = 0;
<a name="l00086"></a>00086    <span class="keywordflow">for</span> (map&lt;Short_t, Result&gt;::const_iterator i = results.begin(); i != results.end(); i++)
<a name="l00087"></a>00087    {
<a name="l00088"></a>00088       <span class="keyword">const</span> <a class="code" href="structResult.html">Result</a> &amp;result = i-&gt;second;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> det = 0; det &lt; <a class="code" href="AsymHeader_8h.html#a4141e3782935f973100a9c0a9efd03b7">N_DETECTORS</a>; det++)
<a name="l00091"></a>00091       {
<a name="l00092"></a>00092          <span class="keywordflow">for</span> (map&lt;<span class="keywordtype">string</span>, vector&lt;double&gt; &gt;::const_iterator it = result.<a class="code" href="structResult.html#aa350123fa5999911729ce66125eb70b9">second</a>.begin(); it != result.<a class="code" href="structResult.html#aa350123fa5999911729ce66125eb70b9">second</a>.end(); it++)
<a name="l00093"></a>00093          {
<a name="l00094"></a>00094             <span class="keywordtype">double</span> value = it-&gt;second[det];
<a name="l00095"></a>00095             <span class="keywordflow">if</span> (!isnan(value))
<a name="l00096"></a>00096             {
<a name="l00097"></a>00097                sigma_sum += (mean - value) * (mean - value);
<a name="l00098"></a>00098                count_crosscheck++;
<a name="l00099"></a>00099             }
<a name="l00100"></a>00100          }
<a name="l00101"></a>00101       }
<a name="l00102"></a>00102    }
<a name="l00103"></a>00103    assert(count == count_crosscheck);
<a name="l00104"></a>00104    <span class="keywordtype">double</span> sigma = sqrt(sigma_sum / count);
<a name="l00105"></a>00105 
<a name="l00106"></a>00106    <span class="keywordflow">for</span> (map&lt;Short_t, Result&gt;::iterator i = results.begin(); i != results.end(); i++)
<a name="l00107"></a>00107    {
<a name="l00108"></a>00108       <a class="code" href="structResult.html">Result</a> &amp;result = i-&gt;second;
<a name="l00109"></a>00109       result.<a class="code" href="structResult.html#a637ca655a5c07576ff5373e792adabf6">min_value</a> = min_value;
<a name="l00110"></a>00110       result.<a class="code" href="structResult.html#a7c22561326cbb70f262b5403e01c6921">max_value</a> = max_value;
<a name="l00111"></a>00111       result.<a class="code" href="structResult.html#ac6e26e4d55c3b38c4fb58efbf7123edc">mean</a> = mean;
<a name="l00112"></a>00112       result.<a class="code" href="structResult.html#aae147943622a916d03ce3ca976722b4c">sigma</a> = sigma;
<a name="l00113"></a>00113    }
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 
<a name="l00117"></a><a class="code" href="mbias-meas_8cxx.html#a5f54fb144e95c0eea5945ce174f14c5c">00117</a> Color_t <a class="code" href="malpha_8cxx.html#a5f54fb144e95c0eea5945ce174f14c5c">GetLineColor</a>(<span class="keywordtype">int</span> det)
<a name="l00118"></a>00118 {
<a name="l00119"></a>00119    Color_t  line_color = det + 2;
<a name="l00120"></a>00120    <span class="keywordflow">if</span> (line_color == 5)
<a name="l00121"></a>00121    {
<a name="l00122"></a>00122       line_color = 28;
<a name="l00123"></a>00123    }
<a name="l00124"></a>00124    <span class="keywordflow">return</span> line_color;
<a name="l00125"></a>00125 }
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 
<a name="l00128"></a><a class="code" href="mbias-meas_8cxx.html#adc24d043e5fffbcf21f97f2c63cf639e">00128</a> <span class="keywordtype">void</span> <a class="code" href="malpha_8cxx.html#ae9a0a75c7d350798779ccaf8e8ff66b4">PlotCorrelation</a>(<a class="code" href="classDrawObjContainer.html">DrawObjContainer</a> *oc, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;polIdName, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <a class="code" href="structResult.html">Result</a> &amp;r1, <a class="code" href="structResult.html">Result</a> &amp;r2)
<a name="l00129"></a>00129 {
<a name="l00130"></a>00130    <a class="code" href="DrawObjContainer_8h.html#a0c3e302f30302eeac5e52f095f785e0a">ObjMap</a>   &amp;o = oc-&gt;<a class="code" href="classDrawObjContainer.html#ae288a17ad6e0151b408beaf77f3e69d9">o</a>;
<a name="l00131"></a>00131    TString  hname(name);
<a name="l00132"></a>00132    hname += <span class="stringliteral">&quot;_&quot;</span>;
<a name="l00133"></a>00133    hname += polIdName;
<a name="l00134"></a>00134    TH2F  *h = <span class="keyword">new</span> TH2F(hname, hname,
<a name="l00135"></a>00135                       r1.<a class="code" href="structResult.html#a7c22561326cbb70f262b5403e01c6921">max_value</a> - r1.<a class="code" href="structResult.html#a637ca655a5c07576ff5373e792adabf6">min_value</a>, r1.<a class="code" href="structResult.html#a637ca655a5c07576ff5373e792adabf6">min_value</a>, r1.<a class="code" href="structResult.html#a7c22561326cbb70f262b5403e01c6921">max_value</a>,
<a name="l00136"></a>00136                       r2.<a class="code" href="structResult.html#a7c22561326cbb70f262b5403e01c6921">max_value</a> - r2.<a class="code" href="structResult.html#a637ca655a5c07576ff5373e792adabf6">min_value</a>, r2.<a class="code" href="structResult.html#a637ca655a5c07576ff5373e792adabf6">min_value</a>, r2.<a class="code" href="structResult.html#a7c22561326cbb70f262b5403e01c6921">max_value</a>);
<a name="l00137"></a>00137 
<a name="l00138"></a>00138    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> det = 0; det &lt; <a class="code" href="AsymHeader_8h.html#a4141e3782935f973100a9c0a9efd03b7">N_DETECTORS</a>; det++)
<a name="l00139"></a>00139    {
<a name="l00140"></a>00140       <span class="keywordtype">int</span>   i = 0;
<a name="l00141"></a>00141       TGraph *g = <span class="keyword">new</span> TGraph(0);
<a name="l00142"></a>00142       Color_t  line_color = det + 2;
<a name="l00143"></a>00143       <span class="keywordflow">if</span> (line_color == 5)
<a name="l00144"></a>00144       {
<a name="l00145"></a>00145          line_color = 28;
<a name="l00146"></a>00146       }
<a name="l00147"></a>00147       g-&gt;SetMarkerColor(line_color);
<a name="l00148"></a>00148 
<a name="l00149"></a>00149       <span class="keywordflow">for</span> (map&lt;<span class="keywordtype">string</span>, vector&lt;double&gt; &gt;::iterator it = r1.<a class="code" href="structResult.html#aa350123fa5999911729ce66125eb70b9">second</a>.begin(); it != r1.<a class="code" href="structResult.html#aa350123fa5999911729ce66125eb70b9">second</a>.end(); it++)
<a name="l00150"></a>00150       {
<a name="l00151"></a>00151          <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;run_name = it-&gt;first;
<a name="l00152"></a>00152          <span class="keywordtype">double</span> value1 = it-&gt;second.at(det);
<a name="l00153"></a>00153          <span class="keywordflow">if</span> (!r2.<a class="code" href="structResult.html#aa350123fa5999911729ce66125eb70b9">second</a>.count(run_name))
<a name="l00154"></a>00154          {
<a name="l00155"></a>00155             <span class="keywordflow">continue</span>;
<a name="l00156"></a>00156          }
<a name="l00157"></a>00157          <span class="keywordtype">double</span> value2 = r2.<a class="code" href="structResult.html#aa350123fa5999911729ce66125eb70b9">second</a>.at(run_name).at(det);
<a name="l00158"></a>00158 
<a name="l00159"></a>00159          g-&gt;Set(i+1);
<a name="l00160"></a>00160          g-&gt;SetPoint(i, value1, value2);
<a name="l00161"></a>00161          cout &lt;&lt; polIdName &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> &lt;&lt; det &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> &lt;&lt; run_name &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> &lt;&lt; value1 &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> &lt;&lt; value2 &lt;&lt; endl;
<a name="l00162"></a>00162          ++i;
<a name="l00163"></a>00163       }
<a name="l00164"></a>00164 
<a name="l00165"></a>00165       h-&gt;GetListOfFunctions()-&gt;Add(g, <span class="stringliteral">&quot;p&quot;</span>);
<a name="l00166"></a>00166    }
<a name="l00167"></a>00167    h-&gt;SetXTitle(r1.<a class="code" href="structResult.html#ad67ff3331aa0731a73843baffaf99984">YTitle</a>.c_str());
<a name="l00168"></a>00168    h-&gt;SetYTitle(r2.<a class="code" href="structResult.html#ad67ff3331aa0731a73843baffaf99984">YTitle</a>.c_str());
<a name="l00169"></a>00169 
<a name="l00170"></a>00170    o[name] = h;
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 
<a name="l00174"></a><a class="code" href="mbias-meas_8cxx.html#a748737ffbaeb942631a4fa7123871054">00174</a> <span class="keywordtype">bool</span> <a class="code" href="malpha_8cxx.html#ac9b740c9a68f0cd1e94315a8472c9d62">FillBiasCurrent</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;run_name, Short_t polId, <span class="keywordtype">double</span> startTime, <span class="keywordtype">double</span> endTime, map&lt;Short_t, Result&gt; &amp;rBiasCurrent)
<a name="l00175"></a>00175 {
<a name="l00176"></a>00176    opencdev::mean_result_t bias_mean_value;
<a name="l00177"></a>00177    <a class="code" href="classCachingLogReader.html">CachingLogReader&lt;SshLogReader&gt;</a> log_reader;
<a name="l00178"></a>00178 
<a name="l00179"></a>00179    <span class="keywordtype">string</span> logger_name = <a class="code" href="classBiasCurrentUtil.html#a08db2f6bd8e723a4dd7e5d0c4d0f1aa8">BiasCurrentUtil::GetBiasCurrentLoggerName</a>((<a class="code" href="AsymCommon_8h.html#ad8de1322331b8e5692418ef9a97f683c">EPolarimeterId</a>)polId);
<a name="l00180"></a>00180    log_reader.query_timerange_mean(logger_name, startTime, endTime, &amp;bias_mean_value);
<a name="l00181"></a>00181 
<a name="l00182"></a>00182    <span class="keywordtype">bool</span> any_values_retrieved = <span class="keyword">false</span>;
<a name="l00183"></a>00183    <span class="keywordflow">for</span>(opencdev::mean_result_t::const_iterator it = bias_mean_value.begin(); it != bias_mean_value.end(); it++)
<a name="l00184"></a>00184    {
<a name="l00185"></a>00185       <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;key = it-&gt;first;
<a name="l00186"></a>00186       <span class="keywordtype">double</span> value = it-&gt;second;
<a name="l00187"></a>00187       Info(<span class="stringliteral">&quot;malpha&quot;</span>, <span class="stringliteral">&quot;Mean %s equals to %f&quot;</span>, key.c_str(), value);
<a name="l00188"></a>00188 
<a name="l00189"></a>00189       <a class="code" href="AsymCommon_8h.html#ad8de1322331b8e5692418ef9a97f683c">EPolarimeterId</a> ssh_PolId = <a class="code" href="classBiasCurrentUtil.html#ad4de8affeb71530839732bcab7ac46e7">BiasCurrentUtil::ParseLoggerPolId</a>(key);
<a name="l00190"></a>00190       <span class="keywordflow">if</span> (ssh_PolId != polId)
<a name="l00191"></a>00191       {
<a name="l00192"></a>00192          <span class="keywordflow">continue</span>;
<a name="l00193"></a>00193       }
<a name="l00194"></a>00194       <span class="keywordtype">int</span>   ssh_DetId = key[15] - <span class="charliteral">&apos;0&apos;</span>;
<a name="l00195"></a>00195 
<a name="l00196"></a>00196       <span class="keywordflow">if</span> (value &gt; 100)
<a name="l00197"></a>00197       {
<a name="l00198"></a>00198          <span class="keywordflow">continue</span>;
<a name="l00199"></a>00199       }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201       rBiasCurrent[polId].second[run_name].resize(<a class="code" href="AsymHeader_8h.html#a4141e3782935f973100a9c0a9efd03b7">N_DETECTORS</a>);
<a name="l00202"></a>00202       rBiasCurrent[polId].second[run_name][ssh_DetId-1] = value;
<a name="l00203"></a>00203 
<a name="l00204"></a>00204       any_values_retrieved = <span class="keyword">true</span>;
<a name="l00205"></a>00205    }
<a name="l00206"></a>00206    <span class="keywordflow">return</span> any_values_retrieved;
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00209"></a><a class="code" href="mbias-meas_8cxx.html#a2f4dc650f48ce93195c3a55ed9ddb823">00209</a> UInt_t <a class="code" href="mbias-meas_8cxx.html#a2f4dc650f48ce93195c3a55ed9ddb823">ParseFillId</a>(<span class="keywordtype">string</span> fRunName)
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211    TObjArray *subStrL = TPRegexp(<span class="stringliteral">&quot;^(\\d+)\\.\\d{3}(|\\.alpha0)$&quot;</span>).MatchS(fRunName);
<a name="l00212"></a>00212 
<a name="l00213"></a>00213    <span class="keywordflow">if</span> (subStrL-&gt;GetEntriesFast() &lt; 1) {
<a name="l00214"></a>00214       Error(<span class="stringliteral">&quot;GetFillId&quot;</span>, <span class="stringliteral">&quot;Cannot extract fill Id from run name&quot;</span>);
<a name="l00215"></a>00215       <span class="keywordflow">return</span> 0;
<a name="l00216"></a>00216    }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218    TString sfillid = ((TObjString *) subStrL-&gt;At(1))-&gt;GetString();
<a name="l00219"></a>00219    <span class="keyword">delete</span> subStrL;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221    UInt_t fFillId = sfillid.Atoi();
<a name="l00222"></a>00222 
<a name="l00223"></a>00223    <span class="keywordflow">if</span> (fFillId &lt;=0 ) {
<a name="l00224"></a>00224       Error(<span class="stringliteral">&quot;GetFillId&quot;</span>, <span class="stringliteral">&quot;Invalid fill ID&quot;</span>);
<a name="l00225"></a>00225       <span class="keywordflow">return</span> 0;
<a name="l00226"></a>00226    }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228    <span class="keywordflow">return</span> fFillId;
<a name="l00229"></a>00229 }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 
<a name="l00232"></a><a class="code" href="mbias-meas_8cxx.html#a44b95a50fa43cd8d424bd10869458950">00232</a> <span class="keywordtype">void</span> <a class="code" href="mbias-meas_8cxx.html#a44b95a50fa43cd8d424bd10869458950">ProcessList</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;filelist, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;results_dir, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;suffix, map&lt;Short_t, Result&gt; &amp;rBiasCurrent, <span class="keywordtype">int</span> mode)
<a name="l00233"></a>00233 {
<a name="l00234"></a>00234    mysqlpp::Connection  fConnection(<span class="stringliteral">&quot;cnipol&quot;</span>, <span class="stringliteral">&quot;pc2pc.phy.bnl.gov&quot;</span>, <span class="stringliteral">&quot;cnipol&quot;</span>, <span class="stringliteral">&quot;(n!P0l&quot;</span>, 3306);
<a name="l00235"></a>00235    <span class="keywordtype">long</span> total = 0, with_meas = 0;
<a name="l00236"></a>00236 
<a name="l00237"></a>00237    <span class="comment">// Fill chain with all input files from filelist</span>
<a name="l00238"></a>00238    TObject *o;
<a name="l00239"></a>00239    TIter   *next = <span class="keyword">new</span> TIter(utils::getFileList(filelist));
<a name="l00240"></a>00240 
<a name="l00241"></a>00241    <span class="comment">// Loop over the runs and record the time of the last flattop measurement in the fill</span>
<a name="l00242"></a>00242    <span class="keywordflow">while</span> (next &amp;&amp; (o = (*next)()) )
<a name="l00243"></a>00243    {
<a name="l00244"></a>00244       <span class="keywordtype">string</span> measId   = string(((TObjString*) o)-&gt;GetName());
<a name="l00245"></a>00245       mysqlpp::Query       select_query = fConnection.query();
<a name="l00246"></a>00246 
<a name="l00247"></a>00247       select_query &lt;&lt; <span class="stringliteral">&quot;SELECT polarimeter_id, start_time, stop_time FROM `run_info` &quot;</span>
<a name="l00248"></a>00248          &lt;&lt; <span class="stringliteral">&quot;WHERE run_name = &quot;</span>
<a name="l00249"></a>00249          &lt;&lt; mysqlpp::quote &lt;&lt; measId
<a name="l00250"></a>00250          &lt;&lt; <span class="stringliteral">&quot;;&quot;</span>;
<a name="l00251"></a>00251       mysqlpp::StoreQueryResult res = select_query.store();
<a name="l00252"></a>00252       <span class="keywordflow">if</span> (res.num_rows() &lt; 1)
<a name="l00253"></a>00253       {
<a name="l00254"></a>00254          Warning(<span class="stringliteral">&quot;malpha&quot;</span>, <span class="stringliteral">&quot;No DB record for %s&quot;</span>, measId.c_str());
<a name="l00255"></a>00255          <span class="keywordflow">continue</span>;
<a name="l00256"></a>00256       }
<a name="l00257"></a>00257       assert(res.num_rows() == 1);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259       <span class="keywordtype">string</span>   runName      = measId;
<a name="l00260"></a>00260       Short_t  polId        = res[0][<span class="stringliteral">&quot;polarimeter_id&quot;</span>];
<a name="l00261"></a>00261       Double_t startTime    = (time_t)((mysqlpp::DateTime)res[0][<span class="stringliteral">&quot;start_time&quot;</span>]);
<a name="l00262"></a>00262       Double_t ssh_endTime  = (time_t)((mysqlpp::DateTime)res[0][<span class="stringliteral">&quot;stop_time&quot;</span>]);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264       <span class="keywordflow">if</span> (ssh_endTime &lt; startTime)
<a name="l00265"></a>00265       {
<a name="l00266"></a>00266          Info(<span class="stringliteral">&quot;malpha&quot;</span>, <span class="stringliteral">&quot;Invalid endtime. Skipping...&quot;</span>);
<a name="l00267"></a>00267          <span class="keywordflow">continue</span>;
<a name="l00268"></a>00268       }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270       <span class="keywordflow">if</span> (mode == 0)
<a name="l00271"></a>00271       {
<a name="l00272"></a>00272          <span class="comment">// nothing</span>
<a name="l00273"></a>00273       }
<a name="l00274"></a>00274       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mode == 1)
<a name="l00275"></a>00275       {
<a name="l00276"></a>00276          startTime = ssh_endTime;
<a name="l00277"></a>00277          ssh_endTime += 300;
<a name="l00278"></a>00278       }
<a name="l00279"></a>00279       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mode == 2)
<a name="l00280"></a>00280       {
<a name="l00281"></a>00281          ssh_endTime = startTime;
<a name="l00282"></a>00282          startTime -= 300;
<a name="l00283"></a>00283       }
<a name="l00284"></a>00284 
<a name="l00285"></a>00285       <span class="keywordflow">if</span> (<a class="code" href="malpha_8cxx.html#ac9b740c9a68f0cd1e94315a8472c9d62">FillBiasCurrent</a>(runName, polId, startTime, ssh_endTime, rBiasCurrent))
<a name="l00286"></a>00286       {
<a name="l00287"></a>00287          with_meas++;
<a name="l00288"></a>00288       }
<a name="l00289"></a>00289       total++;
<a name="l00290"></a>00290    }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292    <a class="code" href="malpha_8cxx.html#a268f9dbb10016e6868784b38d350c51e">FillDeviceMaxMin</a>(rBiasCurrent);
<a name="l00293"></a>00293 
<a name="l00294"></a>00294    cout &lt;&lt; <span class="stringliteral">&quot;============================================&quot;</span> &lt;&lt; endl;
<a name="l00295"></a>00295    cout &lt;&lt; <span class="stringliteral">&quot;BC retrieval success rate for &quot;</span> &lt;&lt; filelist &lt;&lt; <span class="stringliteral">&quot; is &quot;</span> &lt;&lt; with_meas / (double)total * 100 &lt;&lt; endl;
<a name="l00296"></a>00296    cout &lt;&lt; <span class="stringliteral">&quot;total = &quot;</span> &lt;&lt; total &lt;&lt; endl;
<a name="l00297"></a>00297    cout &lt;&lt; <span class="stringliteral">&quot;with_meas = &quot;</span> &lt;&lt; with_meas &lt;&lt; endl;
<a name="l00298"></a>00298    cout &lt;&lt; <span class="stringliteral">&quot;============================================&quot;</span> &lt;&lt; endl;
<a name="l00299"></a>00299 }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301 
<a name="l00303"></a><a class="code" href="mbias-meas_8cxx.html#a0ddf1224851353fc92bfbff6f499fa97">00303</a> <span class="keywordtype">int</span> <a class="code" href="asym_8cxx.html#a0ddf1224851353fc92bfbff6f499fa97" title="The main function of `asym`.">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00304"></a>00304 {
<a name="l00305"></a>00305    setbuf(stdout, NULL);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307    <span class="comment">// Create a default one</span>
<a name="l00308"></a>00308    <a class="code" href="AsymCommon_8cxx.html#a4ea09dca810048da3a6c153c741478c2">gMeasInfo</a> = <span class="keyword">new</span> <a class="code" href="classMeasInfo.html">MeasInfo</a>();
<a name="l00309"></a>00309 
<a name="l00310"></a>00310    <span class="comment">// Do not attempt to recover files</span>
<a name="l00311"></a>00311    gEnv-&gt;SetValue(<span class="stringliteral">&quot;TFile.Recover&quot;</span>, 0);
<a name="l00312"></a>00312 
<a name="l00313"></a>00313    gROOT-&gt;Macro(<span class="stringliteral">&quot;~/rootmacros/styles/style_malpha.C&quot;</span>);
<a name="l00314"></a>00314 
<a name="l00315"></a>00315    map&lt;Short_t, Result&gt; rSweepBeamCurrent;
<a name="l00316"></a>00316    map&lt;Short_t, Result&gt; rPostSweepBeamCurrent;
<a name="l00317"></a>00317    map&lt;Short_t, Result&gt; rPreSweepBeamCurrent;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319    <a class="code" href="mbias-meas_8cxx.html#a44b95a50fa43cd8d424bd10869458950">ProcessList</a>(<span class="stringliteral">&quot;/eicdata/eic0005/runXX/lists/run13_phys&quot;</span>, <span class="stringliteral">&quot;/eicdata/eic0005/veprbl/phys&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, rSweepBeamCurrent, 0);
<a name="l00320"></a>00320    <a class="code" href="mbias-meas_8cxx.html#a44b95a50fa43cd8d424bd10869458950">ProcessList</a>(<span class="stringliteral">&quot;/eicdata/eic0005/runXX/lists/run13_phys&quot;</span>, <span class="stringliteral">&quot;/eicdata/eic0005/veprbl/phys&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, rPostSweepBeamCurrent, 1);
<a name="l00321"></a>00321    <a class="code" href="mbias-meas_8cxx.html#a44b95a50fa43cd8d424bd10869458950">ProcessList</a>(<span class="stringliteral">&quot;/eicdata/eic0005/runXX/lists/run13_phys&quot;</span>, <span class="stringliteral">&quot;/eicdata/eic0005/veprbl/phys&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, rPreSweepBeamCurrent, 2);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323    TFile *f1 = <span class="keyword">new</span> TFile(<span class="stringliteral">&quot;output.root&quot;</span>, <span class="stringliteral">&quot;RECREATE&quot;</span>);
<a name="l00324"></a>00324    <a class="code" href="classDrawObjContainer.html">DrawObjContainer</a> *oc = <span class="keyword">new</span> <a class="code" href="classDrawObjContainer.html">DrawObjContainer</a>(f1);
<a name="l00325"></a>00325    <a class="code" href="AsymCommon_8h.html#a5986df0b91990b2d76ea4a98ea1ee48a">PolarimeterIdSetConstIter</a> iPolId = <a class="code" href="AsymCommon_8cxx.html#a1f6d9a5740e1ea08450a3639a1683ab9">gRunConfig</a>.<a class="code" href="classRunConfig.html#aa9056de0f9dd9d62006ed7e1388a0b90">fPolarimeters</a>.begin();
<a name="l00326"></a>00326 
<a name="l00327"></a>00327    <span class="keywordflow">for</span> ( ; iPolId != <a class="code" href="AsymCommon_8cxx.html#a1f6d9a5740e1ea08450a3639a1683ab9">gRunConfig</a>.<a class="code" href="classRunConfig.html#aa9056de0f9dd9d62006ed7e1388a0b90">fPolarimeters</a>.end(); ++iPolId)
<a name="l00328"></a>00328    {
<a name="l00329"></a>00329       Short_t polId = *iPolId;
<a name="l00330"></a>00330       <span class="keywordtype">string</span>  polIdName = <a class="code" href="classRunConfig.html#addc30f5997de7f4267c442a285434fb2">RunConfig::AsString</a>(*iPolId);
<a name="l00331"></a>00331 
<a name="l00332"></a>00332       rSweepBeamCurrent[polId].YTitle = <span class="stringliteral">&quot;I_{bias}\\ during\\ sweep,\\ \\mu A&quot;</span>;
<a name="l00333"></a>00333       rPostSweepBeamCurrent[polId].YTitle = <span class="stringliteral">&quot;I_{bias}\\ after\\ sweep,\\ \\mu A&quot;</span>;
<a name="l00334"></a>00334       rPreSweepBeamCurrent[polId].YTitle = <span class="stringliteral">&quot;I_{bias}\\ before\\ sweep,\\ \\mu A&quot;</span>;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336       oc-&gt;<a class="code" href="classDrawObjContainer.html#ae762b02a32ea3f1684da098342b93149">d</a>[polIdName] = <span class="keyword">new</span> <a class="code" href="classDrawObjContainer.html">DrawObjContainer</a>(f1-&gt;mkdir(polIdName.c_str()));
<a name="l00337"></a>00337       <a class="code" href="classDrawObjContainer.html">DrawObjContainer</a> *sub_oc = oc-&gt;<a class="code" href="classDrawObjContainer.html#ae762b02a32ea3f1684da098342b93149">d</a>[polIdName];
<a name="l00338"></a>00338 
<a name="l00339"></a>00339       <a class="code" href="malpha_8cxx.html#ae9a0a75c7d350798779ccaf8e8ff66b4">PlotCorrelation</a>(sub_oc, polIdName, <span class="stringliteral">&quot;hSweepBC_vs_PostSweepBC&quot;</span>, rSweepBeamCurrent[polId], rPostSweepBeamCurrent[polId]);
<a name="l00340"></a>00340       <a class="code" href="malpha_8cxx.html#ae9a0a75c7d350798779ccaf8e8ff66b4">PlotCorrelation</a>(sub_oc, polIdName, <span class="stringliteral">&quot;hSweepBC_vs_PreSweepBC&quot;</span>, rSweepBeamCurrent[polId], rPreSweepBeamCurrent[polId]);
<a name="l00341"></a>00341    }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343    TCanvas r(<span class="stringliteral">&quot;r&quot;</span>);
<a name="l00344"></a>00344    oc-&gt;<a class="code" href="classDrawObjContainer.html#ad7436c692997a6232e6f6f7453313c20">SaveAllAs</a>(<a class="code" href="classDrawObjContainer.html#a085d20f5f5a493e742b6794fbc703681">DrawObjContainer::FORMAT_EPS</a>, r, <span class="stringliteral">&quot;^.*$&quot;</span>, <span class="stringliteral">&quot;/tmp/&quot;</span>, <span class="keyword">false</span>);
<a name="l00345"></a>00345    oc-&gt;<a class="code" href="classDrawObjContainer.html#a5669e588bf5360927953d5ba354fa997">Write</a>();
<a name="l00346"></a>00346    f1-&gt;Close();
<a name="l00347"></a>00347    <span class="keyword">delete</span> f1;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349    <span class="keywordflow">return</span> EXIT_SUCCESS;
<a name="l00350"></a>00350 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 3 Dec 2014 for cnipol by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
